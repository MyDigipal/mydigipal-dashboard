<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyDigipal Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23211F54'/%3E%3Ctext x='50' y='68' font-size='50' font-family='Arial' font-weight='bold' fill='white' text-anchor='middle'%3EM%3C/text%3E%3C/svg%3E">

    <!-- External CSS -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- External Libraries -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="logo">üìä</div>
            <h1>MyDigipal Dashboard</h1>
            <p>Connectez-vous pour acc√©der au tableau de bord</p>
            <div id="googleSignIn"></div>
            <div class="login-error" id="loginError">
                Acc√®s refus√©. Seuls les utilisateurs autoris√©s peuvent acc√©der.
            </div>
        </div>
    </div>

    <!-- Dashboard (hidden until login) -->
    <div class="dashboard" id="dashboard">
        <div class="header">
            <div>
                <h1>MyDigipal Dashboard</h1>
                <div class="subtitle">Rentabilit√© &amp; Performance</div>
            </div>
            <div class="user-info">
                <span id="userName"></span>
                <img id="userPhoto" src="" alt="">
                <button class="logout-btn" id="logoutBtn">D√©connexion</button>
            </div>
        </div>

        <!-- Date Filter Bar -->
        <div class="date-filter-bar" id="dateFilterBar">
            <label>üìÖ P√©riode :</label>
            <button class="date-preset active" data-preset="7days">7 jours</button>
            <button class="date-preset" data-preset="30days">30 jours</button>
            <button class="date-preset" data-preset="90days">90 jours</button>
            <button class="date-preset" data-preset="lastmonth">Mois dernier</button>
            <button class="date-preset" data-preset="ytd">YTD</button>
            <button class="date-preset" data-preset="all">Tout</button>
            <div class="date-range-inputs" id="customDateRange">
                <label style="font-size: 0.85em; color: #666; margin: 0 5px;">Du</label>
                <input type="date" class="date-input" id="dateFrom">
                <label style="font-size: 0.85em; color: #666; margin: 0 5px;">au</label>
                <input type="date" class="date-input" id="dateTo">
                <button class="apply-btn" id="applyDateRange">‚úì Appliquer</button>
            </div>
            <div class="current-period" id="currentPeriod">7 derniers jours</div>
        </div>

        <div class="container">
            <!-- KPI Cards (Admin only) -->
            <div class="kpi-grid hidden" id="kpiGrid">
                <div class="kpi-card">
                    <div class="label">Revenue Total</div>
                    <div class="value blue" id="kpiRevenue">-</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Co√ªt Total</div>
                    <div class="value red" id="kpiCost">-</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Profit Total</div>
                    <div class="value green" id="kpiProfit">-</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Marge Moyenne</div>
                    <div class="value purple" id="kpiMargin">-</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs" id="tabsContainer">
                <button class="tab admin-only" data-tab="clients">üìä Rentabilit√©</button>
                <button class="tab admin-only" data-tab="monthly">üìà √âvolution</button>
                <button class="tab admin-only" data-tab="performance">üíº Performance</button>
                <button class="tab admin-only" data-tab="analytics">üìà Analytics</button>
                <button class="tab" data-tab="hours">‚è±Ô∏è Heures</button>
                <button class="tab" data-tab="clientdetail">üè¢ Client</button>
                <button class="tab" data-tab="planning">üìã Planning</button>
                <button class="tab" data-tab="health">üè• Data Health</button>
                <button class="tab" data-tab="ai-reports">ü§ñ AI Reports</button>
            </div>

            <!-- Clients Panel (Admin only) -->
            <div class="panel" id="panel-clients">
                <!-- Toggle Paul filter -->
                <label class="filter-toggle" id="filterTogglePaul">
                    <input type="checkbox" id="includePaulCheckbox">
                    <span class="filter-toggle-icon">üë§</span>
                    <span class="filter-toggle-label">Inclure heures Paul sur MyDigipal</span>
                    <span class="filter-toggle-switch"></span>
                </label>

                <h2>Rentabilit√© par Client</h2>
                <div class="chart-container">
                    <canvas id="clientsChart"></canvas>
                </div>
                <table id="clientsTable">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th class="text-right">Revenue</th>
                            <th class="text-right">Co√ªt</th>
                            <th class="text-right">Heures</th>
                            <th class="text-right">Profit</th>
                            <th class="text-right">Marge</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot id="clientsTableFooter"></tfoot>
                </table>
            </div>

            <!-- Monthly Panel (Admin only) -->
            <div class="panel" id="panel-monthly">
                <h2>√âvolution Mensuelle</h2>

                <!-- Comparison Cards -->
                <div class="comparison-grid" id="comparisonCards">
                    <div class="comparison-card">
                        <div class="comparison-header">üìä Mois dernier vs Mois en cours</div>
                        <div class="comparison-stats">
                            <div class="stat-item">
                                <span class="stat-label">Revenue</span>
                                <span class="stat-value" id="momRevenue">-</span>
                                <span class="stat-trend" id="momRevenueTrend"></span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Profit</span>
                                <span class="stat-value" id="momProfit">-</span>
                                <span class="stat-trend" id="momProfitTrend"></span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Marge</span>
                                <span class="stat-value" id="momMargin">-</span>
                                <span class="stat-trend" id="momMarginTrend"></span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Heures</span>
                                <span class="stat-value" id="momHours">-</span>
                                <span class="stat-trend" id="momHoursTrend"></span>
                            </div>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="comparison-header">üìÖ M√™me mois ann√©e derni√®re</div>
                        <div class="comparison-stats">
                            <div class="stat-item">
                                <span class="stat-label">Revenue</span>
                                <span class="stat-value" id="yoyRevenue">-</span>
                                <span class="stat-trend" id="yoyRevenueTrend"></span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Profit</span>
                                <span class="stat-value" id="yoyProfit">-</span>
                                <span class="stat-trend" id="yoyProfitTrend"></span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Marge</span>
                                <span class="stat-value" id="yoyMargin">-</span>
                                <span class="stat-trend" id="yoyMarginTrend"></span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Heures</span>
                                <span class="stat-value" id="yoyHours">-</span>
                                <span class="stat-trend" id="yoyHoursTrend"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-top: 2rem;">Tendance sur 12 mois</h3>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- Performance Panel (Admin only) -->
            <div class="panel" id="panel-performance">
                <h2>üíº Performance des Employ√©s</h2>

                <div class="charts-grid">
                    <div class="chart-box">
                        <h4>Taux de Facturation (%)</h4>
                        <div class="chart-container medium">
                            <canvas id="billableRateChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-box">
                        <h4>Revenue G√©n√©r√© (¬£)</h4>
                        <div class="chart-container medium">
                            <canvas id="employeeRevenueChart"></canvas>
                        </div>
                    </div>
                </div>

                <h3>D√©tail par Employ√©</h3>
                <table id="performanceTable">
                    <thead>
                        <tr>
                            <th>Employ√©</th>
                            <th class="text-right">Heures Totales</th>
                            <th class="text-right">Heures Facturables</th>
                            <th class="text-right">Taux Facturation</th>
                            <th class="text-right">Revenue G√©n√©r√©</th>
                            <th class="text-right">Co√ªt</th>
                            <th class="text-right">Profit</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot id="performanceTableFooter"></tfoot>
                </table>
            </div>

            <!-- Hours Panel -->
            <div class="panel" id="panel-hours">
                <h2>‚è±Ô∏è R√©partition des Heures</h2>

                <!-- Toggle internal filter -->
                <label class="filter-toggle" id="filterToggleInternal">
                    <input type="checkbox" id="excludeInternalCheckbox">
                    <span class="filter-toggle-icon">üè¢</span>
                    <span class="filter-toggle-label">Masquer travail interne</span>
                    <span class="filter-toggle-switch"></span>
                </label>

                <h3>Par Employ√©</h3>
                <div class="chart-container tall">
                    <canvas id="employeesChart"></canvas>
                </div>

                <h3>D√©tail des heures</h3>
                <table id="employeesTable">
                    <thead>
                        <tr>
                            <th>Employ√©</th>
                            <th class="text-right">Heures</th>
                            <th class="text-right">% du total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot id="employeesTableFooter"></tfoot>
                </table>
            </div>

            <!-- Client Detail Panel -->
            <div class="panel" id="panel-clientdetail">
                <h2>üè¢ D√©tail par Client</h2>

                <div class="client-selector">
                    <label>S√©lectionner un client :</label>
                    <select id="clientSelect">
                        <option value="">-- Choisir un client --</option>
                    </select>
                    <div class="client-total-hours" id="clientTotalHours"></div>
                </div>

                <div id="clientDetailContent" style="display: none;">
                    <div class="charts-grid">
                        <div class="chart-box">
                            <h4>üìÖ √âvolution journali√®re des heures</h4>
                            <div class="chart-container medium">
                                <canvas id="clientTimelineChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-box">
                            <h4>üë• R√©partition par employ√©</h4>
                            <div class="chart-container medium">
                                <canvas id="clientEmployeesChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <h3>D√©tail par employ√©</h3>
                    <table id="clientEmployeesTable">
                        <thead>
                            <tr>
                                <th>Employ√©</th>
                                <th class="text-right">Heures</th>
                                <th class="text-right">% du total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="clientDetailEmpty" class="empty-state">
                    <div class="icon">üè¢</div>
                    <p>S√©lectionnez un client pour voir le d√©tail des heures travaill√©es</p>
                </div>
            </div>

            <!-- Planning Panel -->
            <div class="panel" id="panel-planning">
                <h2>üìã Planning - Budget vs R√©el</h2>

                <div class="filter-controls">
                    <label>
                        <strong>Mois :</strong>
                        <select id="planningMonthSelect">
                            <option value="">Chargement...</option>
                        </select>
                    </label>
                </div>

                <!-- Summary KPIs -->
                <div class="planning-summary" id="planningSummary">
                    <div class="planning-summary-card">
                        <div class="label">Budget Total</div>
                        <div class="value blue" id="planningTotalBudget">-</div>
                    </div>
                    <div class="planning-summary-card">
                        <div class="label">R√©el Total</div>
                        <div class="value purple" id="planningTotalActual">-</div>
                    </div>
                    <div class="planning-summary-card">
                        <div class="label">Restant</div>
                        <div class="value orange" id="planningRemaining">-</div>
                    </div>
                    <div class="planning-summary-card">
                        <div class="label">Progression Mois</div>
                        <div class="value green" id="planningMonthProgress">-</div>
                    </div>
                </div>

                <!-- Client budget cards -->
                <div id="planningCards">
                    <div class="loading">
                        <div class="spinner"></div>
                        Chargement des donn√©es...
                    </div>
                </div>

                <div id="planningEmpty" class="empty-state" style="display: none;">
                    <div class="icon">üìã</div>
                    <p>Aucun budget d√©fini pour ce mois.<br>Ajoutez des budgets dans BigQuery pour les voir ici.</p>
                </div>
            </div>

            <!-- Data Health Panel -->
            <div class="panel" id="panel-health">
                <h2>üè• Data Pipeline Health</h2>
                <p class="health-subtitle">Last check: <span id="healthLastCheck">-</span></p>

                <!-- Health Status Table -->
                <table id="healthTable">
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th class="text-center">Status</th>
                            <th class="text-right">Latest Data</th>
                            <th class="text-right">Lag</th>
                            <th class="text-right">Rows (7d)</th>
                            <th>Issues</th>
                        </tr>
                    </thead>
                    <tbody id="healthTableBody">
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    Chargement des donn√©es...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Health Timeline Chart -->
                <h3 style="margin-top: 2rem;">Historique (30 derniers jours)</h3>
                <div class="chart-container">
                    <canvas id="healthTimelineChart"></canvas>
                </div>
            </div>

            <!-- Analytics Panel (Admin only) -->
            <div class="panel" id="panel-analytics">
                <h2>üìà Analytics - Rapports Marketing</h2>
                <p class="analytics-subtitle">S√©lectionnez un client et une source pour afficher le rapport interactif</p>

                <!-- Filtres -->
                <div class="analytics-filters">
                    <div class="filter-group">
                        <label>Client</label>
                        <select id="analyticsClient" class="analytics-select">
                            <option value="">-- S√©lectionner un client --</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Source</label>
                        <select id="analyticsSource" class="analytics-select">
                            <option value="meta">Meta Ads (Facebook & Instagram)</option>
                            <option value="google-ads">Google Ads</option>
                            <option value="linkedin-ads">LinkedIn Ads</option>
                            <option value="ga4">Google Analytics 4</option>
                            <option value="search-console">Search Console</option>
                            <option value="multi">Multi-Source (Paid Media)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button id="analyticsLoadBtn" class="btn-primary">üìä Charger le rapport</button>
                    </div>
                </div>

                <!-- Account selection panel (shows when multiple accounts available) -->
                <div id="analyticsAccountSelection" class="analytics-account-panel" style="display: none;">
                    <div class="account-panel-header">
                        <strong>Comptes √† inclure:</strong>
                    </div>
                    <div id="analyticsAccountCheckboxes" class="account-checkbox-list"></div>
                </div>

                <!-- Rapport container -->
                <div id="analyticsReportContainer" class="analytics-report-container">
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <h3>S√©lectionnez un client et une source</h3>
                        <p>Choisissez un client, une source de donn√©es et une p√©riode pour afficher le rapport interactif</p>
                    </div>
                </div>
            </div>

            <!-- AI Reports Panel -->
            <div class="panel" id="panel-ai-reports">
                <div class="ai-reports-container">
                    <div class="ai-reports-header">
                        <h2>ü§ñ AI Reports - Rapports Clients Marketing</h2>
                        <p class="ai-subtitle">G√©n√©rez des rapports analytics complets (Meta Ads, Google Ads, GA4, Search Console) en fran√ßais automatiquement</p>
                    </div>

                    <div class="ai-chat-container">
                        <div class="ai-chat-messages" id="aiChatMessages">
                            <!-- Messages du chat appara√Ætront ici -->
                            <div class="ai-welcome-message">
                                <h3>Bienvenue! üëã</h3>
                                <p>Je suis votre assistant pour cr√©er des rapports marketing clients. Voici quelques exemples:</p>
                                <ul>
                                    <li>"Cr√©e un rapport complet pour Vulcain en d√©cembre 2025"</li>
                                    <li>"Analyse les performances Meta Ads de GGP sur les 30 derniers jours"</li>
                                    <li>"Rapport Google Ads + Search Console pour Groupe Th√©obald en janvier 2026"</li>
                                    <li>"Quelles sont les meilleures campagnes Meta pour Guyane Automobile ce mois?"</li>
                                    <li>"Analyse GA4 de Woodcote & Copse du 1er au 15 janvier"</li>
                                </ul>
                                <p style="margin-top: 12px; font-size: 13px; color: #64748b;">
                                    üí° Astuce: Sp√©cifie le client, la p√©riode et les plateformes que tu veux analyser.
                                </p>
                            </div>
                        </div>

                        <div class="ai-chat-input-container">
                            <textarea
                                id="aiMessageInput"
                                class="ai-message-input"
                                placeholder="Posez votre question ici..."
                                rows="2"
                            ></textarea>
                            <button id="aiSendMessage" class="ai-send-button">
                                <span>Envoyer</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Scripts (loaded in order) -->
    <script>
        // Disable datalabels globally - only enable on specific charts
        Chart.defaults.plugins.datalabels = { display: false };
    </script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/tabs.js"></script>
    <script src="js/export.js"></script>
    <script src="js/health.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/ai-reports.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
