<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyDigipal Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23211F54'/%3E%3Ctext x='50' y='68' font-size='50' font-family='Arial' font-weight='bold' fill='white' text-anchor='middle'%3EM%3C/text%3E%3C/svg%3E">

    <!-- External CSS -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- External Libraries -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="logo">üìä</div>
            <h1>MyDigipal Dashboard</h1>
            <p>Connectez-vous pour acc√©der au tableau de bord</p>
            <div id="googleSignIn"></div>
            <div class="login-error" id="loginError">
                Acc√®s refus√©. Seuls les utilisateurs autoris√©s peuvent acc√©der.
            </div>
        </div>
    </div>

    <!-- Dashboard (hidden until login) -->
    <div class="dashboard" id="dashboard">
        <div class="header">
            <div>
                <h1>MyDigipal Dashboard</h1>
                <div class="subtitle">Rentabilit√© &amp; Performance</div>
            </div>
            <div class="user-info">
                <span id="userName"></span>
                <img id="userPhoto" src="" alt="">
                <button class="logout-btn" id="logoutBtn">D√©connexion</button>
            </div>
        </div>

        <!-- Date Filter Bar -->
        <div class="date-filter-bar" id="dateFilterBar">
            <label>üìÖ P√©riode :</label>
            <button class="date-preset" data-preset="all">Tout</button>
            <button class="date-preset active" data-preset="7days">7 jours</button>
            <button class="date-preset" data-preset="30days">30 jours</button>
            <button class="date-preset" data-preset="90days">90 jours</button>
            <button class="date-preset" data-preset="ytd">YTD</button>
            <div class="date-range-inputs" id="customDateRange">
                <input type="date" class="date-input" id="dateFrom">
                <span>‚Üí</span>
                <input type="date" class="date-input" id="dateTo">
                <button class="apply-btn" id="applyDateRange">Appliquer</button>
            </div>
            <div class="current-period" id="currentPeriod">7 derniers jours</div>
        </div>

        <div class="container">
            <!-- KPI Cards (Admin only) -->
            <div class="kpi-grid hidden" id="kpiGrid">
                <div class="kpi-card">
                    <div class="label">Revenue Total</div>
                    <div class="value blue" id="kpiRevenue">-</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Co√ªt Total</div>
                    <div class="value red" id="kpiCost">-</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Profit Total</div>
                    <div class="value green" id="kpiProfit">-</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Marge Moyenne</div>
                    <div class="value purple" id="kpiMargin">-</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs" id="tabsContainer">
                <button class="tab" data-tab="rentabilite">üìä Rentabilit√©</button>
                <button class="tab" data-tab="evolution">üìà √âvolution</button>
                <button class="tab" data-tab="heures">‚è±Ô∏è Heures</button>
                <button class="tab" data-tab="client">üè¢ Client</button>
                <button class="tab" data-tab="planning">üìã Planning</button>
            </div>

            <!-- Rentabilit√© Panel (Admin only) -->
            <div class="panel" id="rentabilitePanel">
                <!-- Toggle Paul filter -->
                <label class="filter-toggle" id="filterTogglePaul">
                    <input type="checkbox" id="includePaulCheckbox">
                    <span class="filter-toggle-icon">üë§</span>
                    <span class="filter-toggle-label">Inclure heures Paul sur MyDigipal</span>
                    <span class="filter-toggle-switch"></span>
                </label>

                <h2>Rentabilit√© par Client</h2>
                <div class="chart-container">
                    <canvas id="clientsChart"></canvas>
                </div>
                <table id="clientsTable">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th class="text-right">Revenue</th>
                            <th class="text-right">Co√ªt</th>
                            <th class="text-right">Heures</th>
                            <th class="text-right">Profit</th>
                            <th class="text-right">Marge</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot id="clientsTableFooter"></tfoot>
                </table>
            </div>

            <!-- √âvolution Panel (Admin only) -->
            <div class="panel" id="evolutionPanel">
                <h2>√âvolution Mensuelle</h2>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- Heures Panel -->
            <div class="panel" id="heuresPanel">
                <h2>‚è±Ô∏è R√©partition des Heures</h2>

                <!-- Toggle internal filter -->
                <label class="filter-toggle" id="filterToggleInternal">
                    <input type="checkbox" id="excludeInternalCheckbox">
                    <span class="filter-toggle-icon">üè¢</span>
                    <span class="filter-toggle-label">Masquer travail interne</span>
                    <span class="filter-toggle-switch"></span>
                </label>

                <h3>Par Employ√©</h3>
                <div class="chart-container tall">
                    <canvas id="employeesChart"></canvas>
                </div>
            </div>

            <!-- Client Detail Panel -->
            <div class="panel" id="clientPanel">
                <h2>üè¢ D√©tail par Client</h2>

                <div class="client-selector">
                    <label>S√©lectionner un client :</label>
                    <select id="clientSelect">
                        <option value="">-- Choisir un client --</option>
                    </select>
                    <div class="client-total-hours" id="clientTotalHours"></div>
                </div>

                <div id="clientDetailContent" style="display: none;">
                    <div class="charts-grid">
                        <div class="chart-box">
                            <h4>üìÖ √âvolution journali√®re des heures</h4>
                            <div class="chart-container medium">
                                <canvas id="clientTimelineChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <h3>D√©tail par employ√©</h3>
                    <table id="clientEmployeesTable">
                        <thead>
                            <tr>
                                <th>Employ√©</th>
                                <th class="text-right">Heures</th>
                                <th class="text-right">% du total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="clientDetailEmpty" class="empty-state">
                    <div class="icon">üè¢</div>
                    <p>S√©lectionnez un client pour voir le d√©tail des heures travaill√©es</p>
                </div>
            </div>

            <!-- Planning Panel -->
            <div class="panel" id="planningPanel">
                <h2>üìã Planning - Budget vs R√©el</h2>

                <div class="filter-controls">
                    <label>
                        <strong>Mois :</strong>
                        <select id="planningMonthSelect">
                            <option value="">Chargement...</option>
                        </select>
                    </label>
                </div>

                <!-- Summary KPIs -->
                <div class="planning-summary" id="planningSummary">
                    <div class="planning-summary-card">
                        <div class="label">Budget Total</div>
                        <div class="value blue" id="planningTotalBudget">-</div>
                    </div>
                    <div class="planning-summary-card">
                        <div class="label">R√©el Total</div>
                        <div class="value purple" id="planningTotalActual">-</div>
                    </div>
                    <div class="planning-summary-card">
                        <div class="label">Restant</div>
                        <div class="value orange" id="planningRemaining">-</div>
                    </div>
                    <div class="planning-summary-card">
                        <div class="label">Progression Mois</div>
                        <div class="value green" id="planningMonthProgress">-</div>
                    </div>
                </div>

                <!-- Client budget cards -->
                <div id="planningCards">
                    <div class="loading">
                        <div class="spinner"></div>
                        Chargement des donn√©es...
                    </div>
                </div>

                <div id="planningEmpty" class="empty-state" style="display: none;">
                    <div class="icon">üìã</div>
                    <p>Aucun budget d√©fini pour ce mois.<br>Ajoutez des budgets dans BigQuery pour les voir ici.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Scripts (loaded in order) -->
    <script>
        // Disable datalabels globally - only enable on specific charts
        Chart.defaults.plugins.datalabels = { display: false };
    </script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/tabs.js"></script>
    <script src="js/export.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
